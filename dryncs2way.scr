#!/bin/bash
# Archivo configuración Variables de mdialog

######################
#    CONFIGURACIÓN   #
######################

# Recuerda llena las variables con las rutas completas
# Ejemplo /ruta/al/archivo/
#
# DESTINO
# Desde dialog se puede cambiar manualmente el directorio destino
# o que cambie a este por defecto escribiendo la ruta aquí

dialogdest="$HOME/"
dialogdest2="$HOME/"

# Lista de Pedido. Ruta Origen

dialogorig="$HOME/"

# Estos archivos se deben crear, es donde se volcarán las rutas de los directorios
# Importante!!! ejecute siempre la 'opción 9 Actualizar Base de Datos' cuando
# haya modificado o aumentado más directorios
#
# Ruta completa, ejemplo /ruta/para/salvar/db/mallrepos

mallrepos="mallrepos"
fallrepos="fallrepos"
callrepos="callrepos"
lallrepos="lallrepos"
jallrepos="jallrepos"
aallrepos="aallrepos"

# Ruta fuente para copiar sus directorios(Ejecute la opción 9 cada vez que cambie esta variable)
# Ejemplo
# msourcepath="$HOME/Programs/REPO_MUSICA/"
# En Cygwin
#fsourcepath="/cygdrive/unidad/REPO_PELICULAS/"
# En Linux
#asourcepath="/path/to/REPO_APPS/"s

msourcepath="/"
fsourcepath="/"
csourcepath="/"
lsourcepath="/"
jsourcepath="/"
asourcepath="/"

# Logs - Estos archivos deben ser creados en las rutas que se listan

# Log Copias Realizadas

copiadoslog="copiados.log"

# Log Copias Fallidas

fallidoslog="fallidos.log"

# Log rsync

rsynclog="dryncs.log"

#######################
#  FIN CONFIGURACIÓN  #
#######################

submenu () {
  clear
  local PS3='Por favor escoga una opción: '
  local options=("Películas" "Música" "JUegos" "Apps" "Libros" "Comics" "Volver")
  local opt
  select opt in "${options[@]}"
  do
      case $opt in
          "Películas")
              if [ -f $fallrepos -a -d "$fsourcepath" ] ; then
                cd "$fsourcepath"
                find . -type f > "$fallrepos"
                sed -i 's/\.\///g' "$fallrepos"
                result=$(echo "DB Películas fallrepos Updated - Base de datos de Películas Actualizado")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de las Películas,\n
revise la configuración de mdialog_conf\n
y las variables:\n
fallrepos\n
fsourcepath")
                display_result "INFORME DB PELÍCULAS"
              fi
              ;;
          "Música")
              if [ -f "$mallrepos" -a -d "$msourcepath" ]; then
                cd "$msourcepath"
                find . -type d > "$mallrepos"
                sed -i 's/\.\///g' "$mallrepos"
                result=$(echo "DB Music mallrepos Updated - Base de datos de Música Actualizada")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de mallrepos, revise la configuración mdialog_conf")
                display_result "INFORME DB MÚSICA"
              fi
              ;;
          "Juegos")
              if [ -f "$jallrepos" -a -d "$jsourcepath" ]; then
                cd "$jsourcepath"
                find . -type d > "$jallrepos"
                sed -i 's/\.\///g' "$jallrepos"
                result=$(echo "DB Apps jallrepos Updated - Base de datos de Juegos Actualizada")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de jallrepos, revise la configuración mdialog_conf")
                display_result "INFORME DB JUEGOS"
              fi
              ;;
          "Apps")
              if [ -f "$aallrepos" -a -d "$asourcepath" ]; then
                cd "$asourcepath"
                find . -type d > "$aallrepos"
                sed -i 's/\.\///g' "$aallrepos"
                result=$(echo "DB Apps aallrepos Updated - Base de datos de Apps Actualizada")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de aallrepos, revise la configuración mdialog_conf")
                display_result "INFORME DB APPS"
              fi
              ;;
          "Libros")
              if [ -f $lallrepos -a -d "$lsourcepath" ] ; then
                cd "$lsourcepath"
                find . -type f > "$lallrepos"
                sed -i 's/\.\///g' "$lallrepos"
                result=$(echo "DB Películas lallrepos Updated - Base de datos de los Libros Actualizado")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de los Libros,\n
revise la configuración de mdialog_conf\n
y las variables:\n
lallrepos\n
lsourcepath")
                display_result "INFORME DB LIBROS"
              fi
              ;;
          "Comics")
              if [ -f $callrepos -a -d "$csourcepath" ] ; then
                cd "$csourcepath"
                find . -type f > "$callrepos"
                sed -i 's/\.\///g' "$callrepos"
                result=$(echo "DB Películas callrepos Updated - Base de datos de Comics Actualizado")
                display_result "INFORME"
              else
                result=$(echo "Falló Actualización de los Comics,\n
revise la configuración de mdialog_conf\n
y las variables:\n
callrepos\n
csourcepath")
                display_result "INFORME DB COMICS"
              fi
              ;;
          "Volver")
              return
              ;;
          *) echo "invalid option $REPLY";;
      esac
      return
  done
}

# while-menu-dialog: a menu driven system information program

# Status Button
DIALOG_CANCEL=1
DIALOG_ESC=255
HEIGHT=16
WIDTH=0

display_result() {
  dialog --title "$1" \
    --no-collapse \
    --msgbox "$result" 0 0
}

while true; do
  exec 3>&1
  selection=$(dialog \
    --backtitle "Panel del Sistema" \
    --title "Menu" \
    --cancel-label "Salir" \
    --menu "Seleccione una Opción:" "$HEIGHT" "$WIDTH" 4 \
    "1" "Listar Dispositivos Montados" \
    "2" "Listar las palabras para buscar y copiar" \
    "3" "Películas" \
    "4" "Música" \
    "5" "Actualizar Bases de Datos" \
    2>&1 1>&3)
    exit_status=$?
    exec 3>&-
# Button Status
  case $exit_status in
    $DIALOG_CANCEL)
      clear
      echo "Programa Terminado"
      exit
      ;;
    $DIALOG_ESC)
      clear
      echo "Programa Abortado" >&2
      exit 1
      ;;
  esac
  case $selection in
    1)
      #result=$(df -Th && lsblk -o +UUID,PARTUUID)
      result=$(lsblk -o +UUID,PARTUUID)
      display_result "Dispositivos Montados"
      ;;
    2)
      
      origen=$(dialog --stdout --title "Ruta Archivo db:" --fselect "$dialogorig" 15 125)
      pedido=$(cat "$origen")
      dialog --no-collapse --title "Lista de Pedido" --msgbox "$pedido" 0 0
      #exec "$0"
      #break 3
      ;;
    3)
# MOVIES BY FILM ID
      counterc=0
      counterf=0
      regdate=$(date)
      cliente=$(dialog --stdout --title "Datos Cliente:" --inputbox "Nombre y Apellido (Prefijo):" 0 0)
      logcopy=$(echo -e "\n\n$cliente - $regdate\n\n" >> "$copiadoslog")
      destino=$(dialog --stdout --title "Seleccionar Carpeta Destino:" --fselect "$dialogdest" 45 125)
      destino2=$(dialog --stdout --title "Seleccionar CArpeta Destino 2: " --fselect "$dialogdest2" 45 125)
      origen=$(dialog --stdout --title "Ruta Lista (ej. fcid.txt)" --fselect "$dialogorig" 45 65)
      lowtoupcase=$(sed -i "s/f/F/g" "$origen")
      exec < "$origen"
      while read -r line
      do
        lct=$(cat "$fallrepos" | grep -iwm 1 "$line")
        lct2=$(grep -Piowm 1 "$line+" $fallrepos) # Extráe solo la palabra lct(F####)
        if [ "$lct2" == "$line" ]; then
# rsync copying with full path or without full path. read man rsync --relative, -R section for understand the "./" bettwen "${msourcepath} and ${lct}"
#		      fuente="${fsourcepath}${lct}"
#         rsync -ah --info=progress2 --log-file="$rsynclog" "$fuente" "$destino"
#         rsync -ah --info=progress2 --log-file="$rsynclog" "$fuente" "$destino2"
# For copy without full path uncomment the lines above and comment the 3 lines below, For replicate the structure of directories, require $destino variable of dialog like, /path/to/REPO_TARGET/, or define in the mdialog_conf, variable section dialogdest="/path/to/REPO_TARJET/" with the slash at the end "/"
          fuente="${fsourcepath}./${lct}"
          rsync -ahR --info=progress2 --log-file="$rsynclog" "$fuente" "$destino"
          #destino 2
          rsync -ahR --info=progress2 --log-file="$rsynclog" "$fuente" "$destino2"
          copiados=$(echo -e "$line" >> "$copiadoslog")
          let counterc=counterc+1
        else
          fallidos=$(echo -e "\n\n$cliente\n\n$line" >> "$fallidoslog")
          listfails=$(echo "$line")
          let counterf=counterf+1
        fi
      done
      let counterrest=counterc-counterf
      pedido=$(cat "$origen")
      dialog --title "Copia Finalizada" \
      --msgbox "\n
          ============ Rutas ============\n
      Lista de ID's     ==> $origen\n
      Folder Destino    ==> $destino\n
      Folder Destino 2  ==> $destino2\n\n
          ============ Items ============\n
                  Reporte\n
      -------------------------------\n
      Total Copiados ==> #$counterrest\n
      total Fallidos ==> #$counterf\n
      Total Pedidos ==> #$counterc\n
      -------------------------------\n\n
      Items Copiados:\n
      $pedido\n\n
      Items Fallidos:\n
      $listfails\n\n
          ============ Logs ============\n
      Log Copiados   ==> $copiadoslog\n
      Log Fallidos   ==> $fallidoslog\n\n" 0 0
      exec cat -n "$copiadoslog"
      ;;
    4)
# MUSIC BY FOLDER ALBUM
      counterc=0
      counterf=0
      regdate=$(date)
      cliente=$(dialog --stdout --title "Datos Cliente:" --inputbox "Nombre y Apellido (Prefijo):" 0 0)
      logcopy=$(echo -e "\n\n$cliente - $regdate\n\n" >> "$copiadoslog")
      destino=$(dialog --stdout --title "Seleccionar Carpeta Destino:" --fselect "$dialogdest" 45 125)
      destino2=$(dialog --stdout --title "Seleccionar Carpeta Destino 2: " --fselect "$dialogdest2" 45 125)
      origen=$(dialog --stdout --title "Ruta Lista (ej. mcid.txt)" --fselect "$dialogorig" 45 65)
      lowtoupcase=$(sed -i "s/m/M/g" "$origen")
      exec < "$origen"
      while read -r line
      do
        lct=$(cat "$mallrepos" | grep -iwm 1 "$line")
        lct2=$(grep -Piowm 1 "$line+" $mallrepos) # Extráe solo la palabra lct(M####) con -o usando regex de Pearl con -P
        if [ "$lct2" == "$line" ]; then
# rsync copying with full path or without full path. read man rsync --relative, -R section for understand the "./" bettwen "${msourcepath} and ${lct}"
#		      fuente="${msourcepath}${lct}"
#         rsync -ah --info=progress2 --log-file="$rsynclog" "$fuente" "$destino"
#         rsync -ah --info=progress2 --log-file="$rsynclog" "$fuente" "$destino2"
# For copy without full path uncomment the lines above and comment the 3 lines below, For replicate the structure of directories, require $destino variable of dialog like, /path/to/REPO_TARGET/, or define in the mdialog_conf, variable section dialogdest="/path/to/REPO_TARJET/" with the slash at the end "/"
          fuente="${msourcepath}./${lct}"		    
          rsync -ahR --info=progress2 --log-file="$rsynclog" "$fuente" "$destino"
          # Destino 2
          rsync -ahR --info=progress2 --log-file="$rsynclog" "$fuente" "$destino2"
          copiados=$(echo -e "$line" >> "$copiadoslog")
          let counterc=counterc+1
        else
          fallidos=$(echo -e "\n\n$cliente\n\n$line" >> "$fallidoslog")
          listfails=$(echo "$line")
          let counterf=counterf+1
        fi
      done
      let counterrest=counterc-counterf
      pedido=$(cat "$origen")
      dialog --title "Copia Finalizada" \
      --msgbox "\n
          ============ Rutas ============\n
      Lista de ID's  ==> $origen\n
      Folder Destino ==> $destino\n
      Folder Destino 2  ==> $destino2\n\n
          ============ Items ============\n
                  Reporte\n
      -------------------------------\n
      Total Copiados ==> #$counterrest\n
      total Fallidos ==> #$counterf\n
      Total Pedidos  ==> #$counterc\n
      rsync log      ==>"$rsynclog"\n
      -------------------------------\n\n
      Items Copiados:\n
      $pedido\n\n
      Items Fallidos:\n
      $listfails\n\n
          ============ Logs ============\n
      Log Copiados   ==> $copiadoslog\n
      Log Fallidos   ==> $fallidoslog\n\n" 0 0
      exec cat -n "$copiadoslog"
      ;;
    5)
      submenu
      ;;
# UPDATE DB's. Note: Write the path msourcepath in mdialog_conf
        #dialog --title "IMPORTANTE!!!!" \
        #--msgbox "\nDB Música actualizado.\n\n
        #    Archivo: $mallrepos\n\n
        #    
        #    --- a Ayuda \n\n
        #    Abrir allrepos con VIM y reemplazar todos los './'\n\n
        #    Comando VIM\n
        #    Buscar y Reemplazar     ==> :%s/.\/\n
        #    Guardar y salir         ==> :wq\n\n
        #    ---------\n\n
        #    Otra opción es sed:\n
        #    $ sed -i 's/\.\///g' allrepos\n
        #    NOTA: -i sobreescribe el archivo allrepos\n
        #          sin -i solo imprime
        #    " 0 0
  esac
done
